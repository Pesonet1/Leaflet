<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Leaflet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  
    <style>
      body { 
        margin:0; padding:0; 
      }
      #map {
        width:100%;
	height:100%;
	position:absolute;
	left:0;	
      }
      
      .menu-ui {
 	background:#fff;
  	position:absolute;
  	top:10px;right:10px;
  	z-index:1;
  	border-radius:3px;
  	width:120px;
  	border:1px solid rgba(0,0,0,0.4);
      }
      .menu-ui a {
    	font-size:13px;
    	color:#404040;
    	display:block;
    	margin:0;padding:0;
    	padding:10px;
    	text-decoration:none;
    	border-bottom:1px solid rgba(0,0,0,0.25);
    	text-align:center;
      }
      .menu-ui a:first-child {
      	border-radius:3px 3px 0 0;
      }
      .menu-ui a:last-child {
      	border:none;
      	border-radius:0 0 3px 3px;
      }
      .menu-ui a:hover {
      	background:#f8f8f8;
      	color:#404040;
      }
      .menu-ui a.active {
      	background:#3887BE;
      	color:#FFF;
      }
      .menu-ui a.active:hover {
        background:#3074a4;
      }
    </style>
  
    <script>
    
      //CORS:n aktivointi, mahdollistaa pyyntöjen tekemisen verkkopiirin ulkopuolelta (domain)
    	(function() {
	  var cors_api_host = 'cors-anywhere.herokuapp.com';
	  var cors_api_url = 'https://' + cors_api_host + '/';
	  var slice = [].slice;
	  var origin = window.location.protocol + '//' + window.location.host;
	  var open = XMLHttpRequest.prototype.open;
	  XMLHttpRequest.prototype.open = function() {
	    var args = slice.call(arguments);
	    var targetOrigin = /^https?:\/\/([^\/]+)/i.exec(args[1]);
	    if (targetOrigin && targetOrigin[0].toLowerCase() !== origin &&
	      targetOrigin[1] !== cors_api_host) {
	        args[1] = cors_api_url + args[1];
	      }
	    return open.apply(this, args);
	  };
	})();
    
    
      function init() {
    	
    	//BASEMAP
  	var map = L.map('map').setView([60.1708, 24.9375], 13);
  	var layers = document.getElementById('menu-ui');
  	
  	L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoicGVzb25ldDEiLCJhIjoiY2lqNXJua2k5MDAwaDI3bTNmaGZqc2ZuaSJ9.nmLkOlsQKzwMir9DfmCNPg', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
			'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
			'Imagery © <a href="http://mapbox.com">Mapbox</a>',
		id: 'mapbox.streets'
	}).addTo(map);
	
	
	
	//WFS-tasot
	var viheralueet_wfs = "http://130.233.249.20:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=web_map_project:hkr_ylre_viheralue&srsName=EPSG:4326&format=json&outputFormat=json&format_options=callback:getJson";
	var vaki_wfs = "http://130.233.249.20:8080/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=WMS:wfs_vaki2014_1km_kp&srsName=EPSG:4326&format=json&outputFormat=json&format_options=callback:getJson";


	/*
	var vaki = new L.GeoJSON();
	function getJson(data) {
		//console.log(data)
		vaki.addData(data);
	}
	$.ajax({ 
        	url: vaki_wfs,
		datatype:"json",
		jsonCallback: 'getJson',
		success: getJson
	});
	*/

	
	//var start_at_zoom = 8;
	
	function onEachFeature(feature, layer) {
	    if (feature.properties && feature.properties.kunta) {
	        layer.bindPopup(feature.properties.kunta);
	    }
	}

	var featureLayer = new L.GeoJSON(
	null, {
	    onEachFeature: onEachFeature
	}).addTo(map);
	
	load_wfs();
	
	function loadGeoJson(data) {
	    //$("#total").html(data.features.length);
	    //featureLayer.clearLayers();
	    featureLayer.addData(data);
	
	}
	
	map.on('moveend', load_wfs);
	
	function load_wfs() {
	    //if (map.getZoom() > start_at_zoom) {
	        var geoJsonUrl = 'http://130.233.249.20:8080/geoserver/wfs';
	        var defaultParameters = {
		    service: 'WFS',
		    format: 'json',
		    version: '1.1.0',
		    request: 'GetFeature',
		    typeName: 'WMS:wfs_vaki2014_1km_kp',
		    //maxFeatures: 6505,
		    outputFormat: 'json', 
		    format_options: 'callback: getJson',
		    srsName:'EPSG:4326'
	        };
		
	        var customParams = {
	            bbox: map.getBounds().toBBoxString()
	        };
	        
	        var parameters = L.Util.extend(defaultParameters); //, customParams);
	        //console.log(geoJsonUrl + L.Util.getParamString(parameters));
	
	        $.ajax({
	            //jsonp: false,
	            url: geoJsonUrl + L.Util.getParamString(parameters),
	            dataType: 'json',
	            jsonpCallback: 'getJson',
	            success: loadGeoJson
	        });
	    //}
	}
	

	/*
	var boundaries = new L.WFS({
	    url: 'http://130.233.249.20:8080/geoserver/ows',
	    typeNS: 'WMS',
	    typeName: 'wfs_vaki2014_1km_kp',
	    crs: L.CRS.EPSG4326,
	    geometryField: 'the_geom',
	    style: {
	        color: 'blue',
	        weight: 2
	    }
	}).addTo(map)
	        //.on('load', function () {
	        //    map.fitBounds(boundaries);
	        //})
	*/
	
	//Toimi jotenkin, mutta kestää ladata tosi kauan...
	/*
	var areas1 = null;
	var ajax = $.ajax({ 
        	url: vaki_wfs,
		datatype:"json",
		jsonCallback: 'getJson',
		success : function (response) {
        	  areas1 = L.geoJson(response, {
                    style: function (feature) {
                      return {
                    	radius: 2,
			fillColor: "#ff7800",
			color: "#000",
			weight: 1,
			opacity: 1,
			fillOpacity: 0.8
                      };
                    }
                    //onEachFeature: function (feature, layer) {
                    //  popupOptions = {maxWidth: 200};
                    //  layer.bindPopup("<b>Viheralueen tunnus: </b> " + feature.properties.kunta
                    //    ,popupOptions);
                    //}
                  }).addTo(map);
                }
	}); 
	*/
	
	

	
	var areas = null;
	var ajax = $.ajax({ 
        	url: viheralueet_wfs,
		datatype:"json",
		jsonCallback: 'getJson',
		success : function (response) {
        	  areas = L.geoJson(response, {
                    style: function (feature) {
                      return {
                        stroke: true,
                        weight: 1,
                        //"stroke-width": 0.5
                	opacity: 1,
                	color: 'black'
                	//dashArray: '3',
                	//fillOpacity: 0.7,
                	//fillColor: '#000'
                      };
                    },
                    onEachFeature: function (feature, layer) {
                      popupOptions = {maxWidth: 200};
                      layer.bindPopup("<b>Viheralueen tunnus: </b> " + feature.properties.viheralue_id +
                        "<br><b>Nimi: </b>" + feature.properties.puiston_nimi +
                        "<br><b>Kayttötarkoitus: </b>" + feature.properties.kayttotarkoitus + 
                        "<br><b>Pinta-ala: </b>" + feature.properties.pinta_ala
                        ,popupOptions);
                    }
                  }).addTo(map);
                }
	}); 
	
	
	
	
	
	//WMS-tasot
	var rakennukset_wms = L.tileLayer.wms("http://130.233.249.20:8080/geoserver/WMS/wms", {
		layers: 'WMS:Rakennukset',
    		format: 'image/png',
    		transparent: true
	}).addTo(map);
	
	var vaki_wms = L.tileLayer.wms("http://130.233.249.20:8080/geoserver/WMS/wms", {
		layers: 'WMS:vaki2014_1km',
    		format: 'image/png',
    		transparent: true
	});

	var aurinko_wms = L.tileLayer.wms("http://130.233.249.20:8080/geoserver/WMS/wms", {
		layers: 'WMS:aurinkosahko_paneeli',
    		format: 'image/png',
    		transparent: true
	});
	
	
	
	//LAYERTOGGLER
	addLayer(rakennukset_wms, 'Rakennukset', 1);
	addLayer(vaki_wms, 'Väkimäärä', 2);
	addLayer(aurinko_wms, 'Aurinkopaneelit', 3);
	//addLayer(ajax, 'Viheralueet', 4);
	//addLayer(viheralueet, 'Viheralueet', 4);
	//addLayer(vaki, 'Väestöruudukko', 5);
	
	map.removeLayer(rakennukset_wms);
	map.removeLayer(vaki_wms);
	map.removeLayer(aurinko_wms);

  	function addLayer(layer, name, zIndex) {
	    layer
	        .setZIndex(zIndex)
	        .addTo(map);
	
	    // Create a simple layer switcher that
	    // toggles layers on and off.
	    var link = document.createElement('a');
	        link.href = '#';
	        link.className = 'active';
	        link.innerHTML = name;
	
	    link.onclick = function(e) {
	        e.preventDefault();
	        e.stopPropagation();
	
	        if (map.hasLayer(layer)) {
	            map.removeLayer(layer);
	            this.className = '';
	        } else {
	            map.addLayer(layer);
	            this.className = 'active';
	        }
	    };
	    
	    layers.appendChild(link);
	}
	
	
	//WMS-tason popup-scripti
	/*
	ms_url="http://130.233.249.20:8080/geoserver/WMS/wms";
	map.addEventListener('click', Identify);
	
	function Identify(e) 
	{
	    // set parameters needed for GetFeatureInfo WMS request
	    var BBOX = map.getBounds().toBBoxString();
	    var WIDTH = map.getSize().x;
	    var HEIGHT = map.getSize().y;
	    var X = map.layerPointToContainerPoint(e.layerPoint).x;
	    var Y = map.layerPointToContainerPoint(e.layerPoint).y;
	     // compose the URL for the request
	    var URL = ms_url + '?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetFeatureInfo&LAYERS=WMS:Rakennukset&QUERY_LAYERS=WMS:Rakennukset&BBOX='+BBOX+'&FEATURE_COUNT=1&HEIGHT='+HEIGHT+'&WIDTH='+WIDTH+'&INFO_FORMAT=text%2Fhtml&SRS=EPSG%3A4326&X='+X+'&Y='+Y;
	
	    //send the asynchronous HTTP request using jQuery $.ajax
	    $.ajax({
	        url: URL,
	        dataType: "html",
	        type: "GET",
	        success: function(data) 
	        {
	            var popup = new L.Popup
	            ({
	                maxWidth: 300
	            });
	
	            popup.setContent(data);
	            popup.setLatLng(e.latlng);
	            map.openPopup(popup);
	        }
	    });
	}
	*/
	
      }
      
    </script>
  </head>  
    
  <body onload="init()">  
    
    <!-- MapBox scriptit -->
    <script src='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.js'></script>
    <link href='https://api.mapbox.com/mapbox.js/v2.2.3/mapbox.css' rel='stylesheet' />
    
    <!-- Leaflet scriptit -->
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    
    <!-- jQuery scriptit -->
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    
    
    <script src="http://pesonet1.github.io/Leaflet/WFS.js"></script>
    
    <nav id='menu-ui' class='menu-ui'></nav>
    <div id="map"></div>
    
  </body>
</html>
